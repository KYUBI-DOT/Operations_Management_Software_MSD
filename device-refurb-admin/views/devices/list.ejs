<%- include('../partials/header') %>

<h1>Devices</h1>

<form class="filters" method="get" action="/devices">
  <input type="hidden" name="pass" value="<%= process.env.ADMIN_PASS %>" />
  <input type="text" name="q" placeholder="Search model/serial" value="<%= filter.q %>"/>
  <select name="status">
    <option value="">All statuses</option>
    <% ['intake','wiping','wiped','resold'].forEach(s => { %>
      <option value="<%= s %>" <%= filter.status===s ? 'selected' : '' %>><%= s %></option>
    <% }) %>
  </select>
  <button type="submit">Apply</button>
</form>

<table class="table">
  <thead>
    <tr><th>ID</th><th>Serial</th><th>Model</th><th>Status</th><th>Grade</th><th>Price</th><th>Actions</th></tr>
  </thead>
  <tbody>
  <% devices.forEach(r => { %>
    <tr>
      <td><%= r.id %></td>
      <td><%= r.serial %></td>
      <td><%= r.model %></td>
      <td><%= r.status %></td>
      <td><%= r.grade || '-' %></td>
      <td><%= r.price != null ? ('$' + r.price) : '-' %></td>
      <td class="actions">
        <a href="/devices/<%= r.id %>/edit?pass=<%= process.env.ADMIN_PASS %>">Edit</a>

        <% if (r.status !== 'wiping') { %>
          <form method="post" action="/devices/<%= r.id %>/status?pass=<%= process.env.ADMIN_PASS %>" style="display:inline">
            <input type="hidden" name="status" value="wiping" />
            <button type="submit">Start Wipe</button>
          </form>
        <% } %>

        <% if (r.status !== 'wiped') { %>
          <form method="post" action="/devices/<%= r.id %>/status?pass=<%= process.env.ADMIN_PASS %>" style="display:inline">
            <input type="hidden" name="status" value="wiped" />
            <button type="submit">Mark Wiped</button>
          </form>
        <% } %>

        <% if (r.status === 'wiped') { %>
          <form method="post" action="/devices/<%= r.id %>/grade?pass=<%= process.env.ADMIN_PASS %>" style="display:inline">
            <select name="grade">
              <option value="A" <%= r.grade==='A'?'selected':'' %>>A</option>
              <option value="B" <%= r.grade==='B'?'selected':'' %>>B</option>
              <option value="C" <%= r.grade==='C'?'selected':'' %>>C</option>
            </select>
            <button type="submit">Set Grade</button>
          </form>
          <form method="post" action="/devices/<%= r.id %>/resell?pass=<%= process.env.ADMIN_PASS %>" style="display:inline">
            <input type="number" name="price" step="0.01" placeholder="Price" />
            <button type="submit">Resell</button>
          </form>
        <% } %>

        <form method="post" action="/devices/<%= r.id %>/delete?pass=<%= process.env.ADMIN_PASS %>" style="display:inline" onsubmit="return confirm('Delete device?')">
          <button type="submit">Delete</button>
        </form>
      </td>
    </tr>
  <% }) %>
  </tbody>
</table>

<%- include('../partials/footer') %>
